<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Test WebSocket Detallado</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }

        .success {
            background: #10b981;
        }

        .error {
            background: #ef4444;
        }

        .warning {
            background: #f59e0b;
        }

        .info {
            background: #3b82f6;
        }

        #log {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #666;
        }

        .log-success {
            border-left-color: #10b981;
        }

        .log-error {
            border-left-color: #ef4444;
        }

        .log-info {
            border-left-color: #3b82f6;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #2563eb;
        }
    </style>
</head>

<body>
    <h1>üîç Test de Conexi√≥n WebSocket Detallado</h1>

    <div id="status" class="status warning">Esperando...</div>

    <div>
        <button onclick="testConnection()">üîÑ Probar Conexi√≥n</button>
        <button onclick="clearLog()">üóëÔ∏è Limpiar Log</button>
    </div>

    <h3>Log de Eventos:</h3>
    <div id="log"></div>

    <script>
        let socket = null;
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');

        function addLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${time}] ${msg}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${msg}`);
        }

        function updateStatus(msg, type) {
            statusDiv.textContent = msg;
            statusDiv.className = `status ${type}`;
        }

        function clearLog() {
            logDiv.innerHTML = '';
            addLog('Log limpiado', 'info');
        }

        function testConnection() {
            addLog('=== INICIANDO TEST DE CONEXI√ìN ===', 'info');

            // Verificar soporte de WebSocket
            if (!window.WebSocket) {
                addLog('‚ùå ERROR: Este navegador no soporta WebSocket', 'error');
                updateStatus('‚ùå Navegador no compatible', 'error');
                return;
            }

            addLog('‚úÖ WebSocket soportado por el navegador', 'success');

            // Cerrar conexi√≥n anterior si existe
            if (socket) {
                addLog('Cerrando conexi√≥n anterior...', 'info');
                socket.close();
                socket = null;
            }

            const wsUrl = 'ws://localhost:8080';
            addLog(`Intentando conectar a: ${wsUrl}`, 'info');
            updateStatus('üîÑ Conectando...', 'warning');

            try {
                socket = new WebSocket(wsUrl);
                addLog('Objeto WebSocket creado', 'success');

                // Timeout de conexi√≥n
                const connectionTimeout = setTimeout(() => {
                    if (socket.readyState !== WebSocket.OPEN) {
                        addLog('‚è±Ô∏è TIMEOUT: La conexi√≥n tard√≥ m√°s de 5 segundos', 'error');
                        socket.close();
                    }
                }, 5000);

                socket.onopen = function (event) {
                    clearTimeout(connectionTimeout);
                    addLog('‚úÖ ¬°CONEXI√ìN EXITOSA!', 'success');
                    addLog(`Estado: ${getReadyStateText(socket.readyState)}`, 'success');
                    updateStatus('‚úÖ Conectado', 'success');

                    // Enviar mensaje de prueba
                    const testMsg = {
                        type: 'login',
                        userId: 999,
                        userName: 'Usuario de Prueba'
                    };
                    addLog(`Enviando mensaje de login: ${JSON.stringify(testMsg)}`, 'info');
                    socket.send(JSON.stringify(testMsg));
                };

                socket.onmessage = function (event) {
                    addLog(`üì© Mensaje recibido: ${event.data}`, 'success');
                    try {
                        const data = JSON.parse(event.data);
                        addLog(`   Tipo: ${data.type}`, 'info');
                    } catch (e) {
                        addLog(`   (No es JSON v√°lido)`, 'info');
                    }
                };

                socket.onerror = function (error) {
                    addLog(`‚ùå ERROR en WebSocket: ${error}`, 'error');
                    addLog(`   Tipo de error: ${error.type}`, 'error');
                    addLog(`   Estado actual: ${getReadyStateText(socket.readyState)}`, 'error');
                    updateStatus('‚ùå Error de conexi√≥n', 'error');
                };

                socket.onclose = function (event) {
                    clearTimeout(connectionTimeout);
                    addLog(`üî¥ Conexi√≥n cerrada`, 'error');
                    addLog(`   C√≥digo: ${event.code}`, 'error');
                    addLog(`   Raz√≥n: ${event.reason || 'No especificada'}`, 'error');
                    addLog(`   ¬øLimpia?: ${event.wasClean ? 'S√≠' : 'No'}`, 'error');
                    updateStatus('üî¥ Desconectado', 'error');

                    // Decodificar c√≥digo de cierre
                    const closeReason = getCloseReason(event.code);
                    addLog(`   Significado: ${closeReason}`, 'info');
                };

            } catch (e) {
                addLog(`‚ùå EXCEPCI√ìN al crear WebSocket: ${e.message}`, 'error');
                addLog(`   Stack: ${e.stack}`, 'error');
                updateStatus('‚ùå Error cr√≠tico', 'error');
            }
        }

        function getReadyStateText(state) {
            const states = {
                0: 'CONNECTING (0)',
                1: 'OPEN (1)',
                2: 'CLOSING (2)',
                3: 'CLOSED (3)'
            };
            return states[state] || `UNKNOWN (${state})`;
        }

        function getCloseReason(code) {
            const reasons = {
                1000: 'Normal closure',
                1001: 'Going away',
                1002: 'Protocol error',
                1003: 'Unsupported data',
                1005: 'No status received',
                1006: 'Abnormal closure (no close frame)',
                1007: 'Invalid frame payload data',
                1008: 'Policy violation',
                1009: 'Message too big',
                1010: 'Missing extension',
                1011: 'Internal server error',
                1015: 'TLS handshake failure'
            };
            return reasons[code] || `Unknown code (${code})`;
        }

        // Auto-test al cargar
        addLog('P√°gina cargada. Presiona "Probar Conexi√≥n" para iniciar.', 'info');
        addLog(`Navegador: ${navigator.userAgent}`, 'info');

        // Test autom√°tico despu√©s de 1 segundo
        setTimeout(testConnection, 1000);
    </script>
</body>

</html>